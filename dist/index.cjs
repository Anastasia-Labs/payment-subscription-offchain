"use strict";var U=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var G=(t,e)=>{for(var r in e)U(t,r,{get:e[r],enumerable:!0})},E=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of J(e))!z.call(t,n)&&n!==r&&U(t,n,{get:()=>e[n],enumerable:!(s=W(e,n))||s.enumerable});return t},O=(t,e,r)=>(E(t,e,"default"),r&&E(r,e,"default"));var Q=t=>E(U({},"__esModule",{value:!0}),t);var A={};G(A,{AddressD:()=>Se,AddressSchema:()=>B,AssetClass:()=>ye,AssetClassSchema:()=>w,CreateServiceRedeemer:()=>R,CreateServiceSchema:()=>H,CredentialD:()=>ve,CredentialSchema:()=>b,MintAccountSchema:()=>$,MintServiceRedeemer:()=>k,ONE_HOUR_MS:()=>Ae,ONE_YEAR_MS:()=>Oe,OutputReference:()=>xe,OutputReferenceSchema:()=>D,PROTOCOL_FEE:()=>we,PROTOCOL_PAYMENT_KEY:()=>ke,PROTOCOL_STAKE_KEY:()=>Ee,ServiceDatum:()=>y,ServiceDatumSchema:()=>j,TIME_TOLERANCE_MS:()=>Re,TWENTY_FOUR_HOURS_MS:()=>be,TWO_YEARS_MS:()=>Ce,Value:()=>Te,ValueSchema:()=>L,chunkArray:()=>oe,createService:()=>ge,createServiceEffect:()=>_e,divCeil:()=>ie,fromAddress:()=>re,fromAddressToData:()=>se,fromAssets:()=>le,generateAccountSeedPhrase:()=>te,getInputUtxoIndices:()=>pe,getServiceMultiValidator:()=>x,ok:()=>X,parseSafeDatum:()=>M,parseUTxOsAtScript:()=>Z,remove:()=>fe,replacer:()=>ae,selectUtxos:()=>ue,sendTokenToService:()=>Ie,sortByOutRefWithIndex:()=>P,sumUtxoAssets:()=>me,toAddress:()=>ne,toAssets:()=>de,toCBORHex:()=>ee,union:()=>ce,updateService:()=>he,utxosAtScript:()=>V});module.exports=Q(A);var p=require("@lucid-evolution/lucid");var I=require("@lucid-evolution/lucid"),x=(t,e)=>{let r={type:"PlutusV2",script:e.minting},s=t.config().network,n=(0,I.validatorToAddress)(s,r),o={type:"PlutusV2",script:e.spending},c=(0,I.validatorToAddress)(s,o);return{spendServiceValidator:o,spendServiceValAddress:c,mintServiceValidator:r,mintServiceValAddress:n}};var i=require("@lucid-evolution/lucid");function X(t){return{type:"ok",data:t}}var V=async(t,e,r)=>{let s=t.config().network,n={type:"PlutusV2",script:e},o=r?(0,i.validatorToAddress)(s,n,(0,i.keyHashToCredential)(r)):(0,i.validatorToAddress)(s,n);return t.utxosAt(o)},M=(t,e)=>{if(t)try{return{type:"right",value:i.Data.from(t,e)}}catch(r){return{type:"left",value:`invalid datum : ${r}`}}else return{type:"left",value:"missing datum"}},Z=async(t,e,r,s)=>{try{return(await V(t,e,s)).flatMap(o=>{let c=M(o.datum,r);return c.type=="right"?{outRef:{txHash:o.txHash,outputIndex:o.outputIndex},datum:c.value,assets:o.assets}:[]})}catch{return[]}},ee=t=>(0,i.applyDoubleCborEncoding)(t),te=async t=>{let e=(0,i.generateSeedPhrase)(),r=await(0,i.Lucid)(new i.Emulator([]),"Custom");r.selectWallet.fromSeed(e);let s=r.wallet().address;return{seedPhrase:e,address:s,assets:t}};function re(t){let{paymentCredential:e,stakeCredential:r}=(0,i.getAddressDetails)(t);if(!e)throw new Error("Not a valid payment address.");return{paymentCredential:e?.type==="Key"?{PublicKeyCredential:[e.hash]}:{ScriptCredential:[e.hash]},stakeCredential:r?{Inline:[r.type==="Key"?{PublicKeyCredential:[r.hash]}:{ScriptCredential:[r.hash]}]}:null}}function ne(t,e){let r=(()=>"PublicKeyCredential"in t.paymentCredential?(0,i.keyHashToCredential)(t.paymentCredential.PublicKeyCredential[0]):(0,i.scriptHashToCredential)(t.paymentCredential.ScriptCredential[0]))(),s=(()=>{if(t.stakeCredential&&"Inline"in t.stakeCredential)return"PublicKeyCredential"in t.stakeCredential.Inline[0]?(0,i.keyHashToCredential)(t.stakeCredential.Inline[0].PublicKeyCredential[0]):(0,i.scriptHashToCredential)(t.stakeCredential.Inline[0].ScriptCredential[0])})();return(0,i.credentialToAddress)(e,r,s)}var se=t=>{let e=(0,i.getAddressDetails)(t);if(!e.paymentCredential)return{type:"error",error:new Error("undefined paymentCredential")};let r=e.paymentCredential.type=="Key"?new i.Constr(0,[e.paymentCredential.hash]):new i.Constr(1,[e.paymentCredential.hash]);if(!e.stakeCredential)return{type:"ok",data:new i.Constr(0,[r,new i.Constr(1,[])])};let s=new i.Constr(0,[new i.Constr(0,[new i.Constr(0,[e.stakeCredential.hash])])]);return{type:"ok",data:new i.Constr(0,[r,s])}},oe=(t,e)=>{let r=Math.ceil(t.length/e);return[...Array(r)].map((s,n)=>t.slice(n*e,(n+1)*e))},ae=(t,e)=>typeof e=="bigint"?e.toString():e,ie=(t,e)=>1n+(t-1n)/e;function ce(t,e){let r=Object.entries(e),s={...t};return r.forEach(([n,o])=>{s[n]?s[n]+=o:s[n]=o}),s}function le(t){let e=new Map;t.lovelace&&e.set("",new Map([["",t.lovelace]]));let r=Object.keys(t);return Array.from(new Set(r.filter(n=>n!=="lovelace").map(n=>n.slice(0,56)))).sort().forEach(n=>{let o=r.filter(l=>l.slice(0,56)===n),c=new Map;o.sort().forEach(l=>{c.set(l.slice(56),t[l])}),e.set(n,c)}),e}function de(t){let e={lovelace:t.get("")?.get("")||BigInt(0)};for(let[r,s]of t)if(r!=="")for(let[n,o]of s)e[r+n]=o;return e}function ue(t,e){let r=[],s=!1,n=new Map(Object.entries(e));for(let o of t)if(!o.scriptRef){s=!1;for(let[c,l]of n)if(Object.hasOwn(o.assets,c)){let u=o.assets[c];u>=l?n.delete(c):n.set(c,l-u),s=!0}if(s&&r.push(o),n.size==0)break}return n.size>0?{type:"error",error:new Error("Insufficient funds")}:{type:"ok",data:r}}function pe(t,e){let r=t.concat(e),s=P(r),n=new Map;return s.forEach((o,c)=>{n.set(o.txHash+o.outputIndex,BigInt(c))}),t.flatMap(o=>{let c=n.get(o.txHash+o.outputIndex);return c!==void 0?c:[]})}function P(t){return t.sort((e,r)=>e.txHash<r.txHash?-1:e.txHash>r.txHash?1:e.txHash==r.txHash?e.outputIndex<r.outputIndex?-1:1:0)}function me(t){return t.map(e=>e.assets).reduce((e,r)=>(0,i.addAssets)(e,r),{})}function fe(t,e){for(let[r,s]of Object.entries(e))Object.hasOwn(t,r)&&(t[r]<s?delete t[r]:t[r]>s?t[r]-=s:delete t[r]);return t}var a=require("@lucid-evolution/lucid"),D=a.Data.Object({txHash:a.Data.Object({hash:a.Data.Bytes({minLength:32,maxLength:32})}),outputIndex:a.Data.Integer()}),xe=D,b=a.Data.Enum([a.Data.Object({PublicKeyCredential:a.Data.Tuple([a.Data.Bytes({minLength:28,maxLength:28})])}),a.Data.Object({ScriptCredential:a.Data.Tuple([a.Data.Bytes({minLength:28,maxLength:28})])})]),ve=b,B=a.Data.Object({paymentCredential:b,stakeCredential:a.Data.Nullable(a.Data.Enum([a.Data.Object({Inline:a.Data.Tuple([b])}),a.Data.Object({Pointer:a.Data.Tuple([a.Data.Object({slotNumber:a.Data.Integer(),transactionIndex:a.Data.Integer(),certificateIndex:a.Data.Integer()})])})]))}),Se=B,w=a.Data.Object({policyId:a.Data.Bytes(),assetName:a.Data.Bytes()}),ye=w,L=a.Data.Map(a.Data.Bytes(),a.Data.Map(a.Data.Bytes(),a.Data.Integer())),Te=L,H=a.Data.Object({output_reference:D,input_index:a.Data.Integer()}),R=H,$=a.Data.Enum([a.Data.Literal("UpdateService"),a.Data.Literal("RemoveService")]),k=$,j=a.Data.Object({service_fee:w,service_fee_qty:a.Data.Integer(),penalty_fee:w,penalty_fee_qty:a.Data.Integer(),interval_length:a.Data.Integer(),num_intervals:a.Data.Integer(),minimum_ada:a.Data.Integer(),is_active:a.Data.Boolean()}),y=j;var v=require("@noble/hashes/utils"),q=require("@noble/hashes/sha3"),T={prefix100:"000643b0",prefix222:"000de140",prefix333:"0014df10",prefix444:"001bc280"},g=(t,e)=>{let r=(0,q.sha3_256)((0,v.hexToBytes)(t.txHash)),s=new Uint8Array([t.outputIndex]),n=(0,v.concatBytes)(r,s),o=(0,v.concatBytes)((0,v.hexToBytes)(e),n);return(0,v.bytesToHex)(o.slice(0,32))};var C=require("effect"),K=t=>{let e=g(t,T.prefix100),r=g(t,T.prefix222);return{refTokenName:e,userTokenName:r}},ge=async(t,e)=>{let r=await t.wallet().address(),s=x(t,e.scripts),n=(0,p.mintingPolicyToId)(s.mintServiceValidator);console.log("servicePolicyId: ",n);let o=await t.utxosAt(r);(!o||!o.length)&&console.error("No UTxO found at user address: "+r);let{refTokenName:c,userTokenName:l}=K(o[0]);console.log("refTokenName: ",c),console.log("userTokenName: ",l);let u={kind:"selected",makeRedeemer:d=>{let N={output_reference:{txHash:{hash:o[0].txHash},outputIndex:BigInt(o[0].outputIndex)},input_index:d[0]};return p.Data.to(N,R)},inputs:[o[0]]};console.log("REDEEMER :: ",u);let _={service_fee:{policyId:"",assetName:""},service_fee_qty:10000000n,penalty_fee:{policyId:"",assetName:""},penalty_fee_qty:1000000n,interval_length:1n,num_intervals:12n,minimum_ada:2000000n,is_active:!0},S=p.Data.to(_,y);console.log("merchantUTxOs :: ",o);let m={[`${n}${c}`]:1n,[`${n}${l}`]:1n};try{let d=await t.newTx().collectFrom(o).mintAssets(m,u).pay.ToAddress(r,{[`${n}${l}`]:1n}).pay.ToContract(s.mintServiceValAddress,{kind:"inline",value:S},{lovelace:1000000n,[`${n}${c}`]:1n}).validTo(Date.now()+9e5).attach.MintingPolicy(s.mintServiceValidator).complete();return console.log("data: ",d.toJSON()),{type:"ok",data:d}}catch(d){return console.log("ERROR: ",d),d instanceof Error?{type:"error",error:d}:{type:"error",error:new Error(`${JSON.stringify(d)}`)}}},_e=async(t,e)=>C.Effect.gen(function*(){let r=yield*C.Effect.promise(()=>t.wallet().address()),s=x(t,e.scripts),n=(0,p.mintingPolicyToId)(s.mintServiceValidator);console.log("servicePolicyId in hex: ",n),console.log("policyId: "+(0,p.fromHex)(n));let o=yield*C.Effect.promise(()=>t.utxosAt(r));console.log("Merchant UTxO"),console.log(o),(!o||!o.length)&&console.error("No UTxO found at user address: "+r);let c=(0,p.selectUTxOs)(o,{lovelace:5000000n}),{refTokenName:l,userTokenName:u}=K(c[0]);console.log("refTokenName: ",l),console.log("userTokenName: ",u);let _={[`${n}${l}`]:1n,[`${n}${u}`]:1n},S={kind:"selected",makeRedeemer:F=>{let Y={output_reference:{txHash:{hash:c[0].txHash},outputIndex:BigInt(c[0].outputIndex)},input_index:F[0]};return p.Data.to(Y,R)},inputs:[c[0]]},m=yield*C.Effect.promise(()=>t.wallet().getUtxos()),d=(0,p.selectUTxOs)(m,{lovelace:BigInt(2e6)});return yield*t.newTx().collectFrom(c).mintAssets(_,S).pay.ToAddress(s.mintServiceValAddress,{[`${n}${l}`]:1n}).validTo(Date.now()+9e5).attach.MintingPolicy(s.mintServiceValidator).completeProgram()});var f=require("@lucid-evolution/lucid");var he=async(t,e)=>{console.log("updateService..........: ");let r=x(t,e.scripts),s=(0,f.toUnit)("cbe8007737fc6a3376cad95dfce70a2c947a0502569d6b9e4fbcf9e9","000643b09e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),n=(0,f.toUnit)("cbe8007737fc6a3376cad95dfce70a2c947a0502569d6b9e4fbcf9e9","000de1409e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),o=await t.utxosAtWithUnit(r.spendServiceValAddress,s);if(!o)throw new Error("Service NFT not found");console.log("serviceNFTUTxO: ",o);let c={service_fee:e.new_service_fee,service_fee_qty:e.new_service_fee_qty,penalty_fee:e.new_penalty_fee,penalty_fee_qty:e.new_penalty_fee_qty,interval_length:e.new_interval_length,num_intervals:e.new_num_intervals,minimum_ada:e.new_minimum_ada,is_active:e.is_active},l=f.Data.to(c,y),u=f.Data.to("UpdateService",k),_=f.Data.to("RemoveService",k);console.log("Redeemer updateService: ",u);let S=f.Data.to(new f.Constr(0,[new f.Constr(0,[])]));try{return{type:"ok",data:await t.newTx().collectFrom(o,S).pay.ToContract(r.spendServiceValAddress,{kind:"inline",value:l},{lovelace:3000000n,[s]:1n}).pay.ToAddress(e.merchantAddr,{[n]:1n}).attach.SpendingValidator(r.spendServiceValidator).complete()}}catch(m){return console.log("ERROR: ",m),m instanceof Error?{type:"error",error:m}:{type:"error",error:new Error(`${JSON.stringify(m)}`)}}};var h=require("@lucid-evolution/lucid");var Ae=36e5,Oe=315576e5,Ce=631152e5,be=864e5,we=.05,Re=process.env.NODE_ENV=="emulator"?0:1e5,ke="014e9d57e1623f7eeef5d0a8d4e6734a562ba32cf910244cd74e1680",Ee="5e8aa3f089868eaadf188426f49db6566624844b6c5d529b38f3b8a7";var Ue=t=>{let e=g(t,T.prefix100),r=g(t,T.prefix222);return{refTokenName:e,userTokenName:r}},Ie=async(t,e)=>{console.log("sendTokenToService...");let r=x(t,e.scripts),s=(0,h.mintingPolicyToId)(r.mintServiceValidator),n=await t.wallet().address(),o=await t.utxosAt(n),c=await t.utxosAt(r.spendServiceValAddress),{refTokenName:l,userTokenName:u}=Ue(o[0]);console.log("Service Validator Address: BEFORE>>>",r.spendServiceValAddress),console.log("Service Validator UTxO: BEFORE>>>",c);let _={service_fee:e.service_fee,service_fee_qty:e.service_fee_qty,penalty_fee:e.penalty_fee,penalty_fee_qty:e.penalty_fee_qty,interval_length:e.interval_length,num_intervals:e.num_intervals,minimum_ada:e.minimum_ada,is_active:e.is_active},S=h.Data.to(_,y),m=(0,h.toUnit)(s,l);console.log("PolicyId: ",s),console.log("refTokenName: ",l),console.log("userTokenName: ",u);try{return{type:"ok",data:await t.newTx().pay.ToContract(r.spendServiceValAddress,{kind:"inline",value:S},{lovelace:5000000n,[m]:1n}).complete()}}catch(d){return console.log("ERROR: ",d),d instanceof Error?{type:"error",error:d}:{type:"error",error:new Error(`${JSON.stringify(d)}`)}}};O(A,require("@lucid-evolution/lucid"),module.exports);0&&(module.exports={AddressD,AddressSchema,AssetClass,AssetClassSchema,CreateServiceRedeemer,CreateServiceSchema,CredentialD,CredentialSchema,MintAccountSchema,MintServiceRedeemer,ONE_HOUR_MS,ONE_YEAR_MS,OutputReference,OutputReferenceSchema,PROTOCOL_FEE,PROTOCOL_PAYMENT_KEY,PROTOCOL_STAKE_KEY,ServiceDatum,ServiceDatumSchema,TIME_TOLERANCE_MS,TWENTY_FOUR_HOURS_MS,TWO_YEARS_MS,Value,ValueSchema,chunkArray,createService,createServiceEffect,divCeil,fromAddress,fromAddressToData,fromAssets,generateAccountSeedPhrase,getInputUtxoIndices,getServiceMultiValidator,ok,parseSafeDatum,parseUTxOsAtScript,remove,replacer,selectUtxos,sendTokenToService,sortByOutRefWithIndex,sumUtxoAssets,toAddress,toAssets,toCBORHex,union,updateService,utxosAtScript,...require("@lucid-evolution/lucid")});
