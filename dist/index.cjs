"use strict";var M=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var Z=(e,t)=>{for(var r in t)M(e,r,{get:t[r],enumerable:!0})},N=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Q(t))!X.call(e,n)&&n!==r&&M(e,n,{get:()=>t[n],enumerable:!(o=G(t,n))||o.enumerable});return e},w=(e,t,r)=>(N(e,t,"default"),r&&N(r,t,"default"));var ee=e=>N(M({},"__esModule",{value:!0}),e);var C={};Z(C,{ADA:()=>V,AddressD:()=>Te,AddressSchema:()=>$,AssetClassD:()=>_e,AssetClassSchema:()=>D,CreateServiceRedeemer:()=>I,CreateServiceSchema:()=>F,CredentialD:()=>ge,CredentialSchema:()=>U,MintServiceRedeemer:()=>B,MintServiceSchema:()=>Y,ONE_HOUR_MS:()=>we,ONE_YEAR_MS:()=>Re,OutputReference:()=>ye,OutputReferenceSchema:()=>P,PROTOCOL_FEE:()=>ke,PROTOCOL_PAYMENT_KEY:()=>De,PROTOCOL_STAKE_KEY:()=>Ie,ServiceDatum:()=>_,ServiceDatumSchema:()=>J,TIME_TOLERANCE_MS:()=>Ue,TWENTY_FOUR_HOURS_MS:()=>Ee,TWO_YEARS_MS:()=>be,Value:()=>he,ValueSchema:()=>K,chunkArray:()=>ce,createService:()=>Ae,createServiceEffect:()=>Oe,divCeil:()=>de,fromAddress:()=>se,fromAddressToData:()=>ie,fromAssets:()=>pe,generateAccountSeedPhrase:()=>oe,getInputUtxoIndices:()=>xe,getServiceMultiValidator:()=>g,ok:()=>te,parseSafeDatum:()=>j,parseUTxOsAtScript:()=>re,remove:()=>Se,replacer:()=>le,selectUtxos:()=>fe,sendTokenToService:()=>Ne,sortByOutRefWithIndex:()=>q,sumUtxoAssets:()=>ve,toAddress:()=>ae,toAssets:()=>me,toCBORHex:()=>ne,union:()=>ue,updateService:()=>Ce,utxosAtScript:()=>H});module.exports=ee(C);var m=require("@lucid-evolution/lucid");var k=require("@lucid-evolution/lucid"),g=(e,t)=>{let r={type:"PlutusV2",script:t.minting},o=e.config().network,n=(0,k.validatorToRewardAddress)(o,r),s={type:"PlutusV2",script:t.spending},c=(0,k.validatorToAddress)(o,s);return{spendServiceValidator:s,spendServiceValAddress:c,mintServiceValidator:r,mintServiceValAddress:n}};var i=require("@lucid-evolution/lucid");function te(e){return{type:"ok",data:e}}var H=async(e,t,r)=>{let o=e.config().network,n={type:"PlutusV2",script:t},s=r?(0,i.validatorToAddress)(o,n,(0,i.keyHashToCredential)(r)):(0,i.validatorToAddress)(o,n);return e.utxosAt(s)},j=(e,t)=>{if(e)try{return{type:"right",value:i.Data.from(e,t)}}catch(r){return{type:"left",value:`invalid datum : ${r}`}}else return{type:"left",value:"missing datum"}},re=async(e,t,r,o)=>{try{return(await H(e,t,o)).flatMap(s=>{let c=j(s.datum,r);return c.type=="right"?{outRef:{txHash:s.txHash,outputIndex:s.outputIndex},datum:c.value,assets:s.assets}:[]})}catch{return[]}},ne=e=>(0,i.applyDoubleCborEncoding)(e),oe=async e=>{let t=(0,i.generateSeedPhrase)(),r=await(0,i.Lucid)(new i.Emulator([]),"Custom");r.selectWallet.fromSeed(t);let o=r.wallet().address;return{seedPhrase:t,address:o,assets:e}};function se(e){let{paymentCredential:t,stakeCredential:r}=(0,i.getAddressDetails)(e);if(!t)throw new Error("Not a valid payment address.");return{paymentCredential:t?.type==="Key"?{PublicKeyCredential:[t.hash]}:{ScriptCredential:[t.hash]},stakeCredential:r?{Inline:[r.type==="Key"?{PublicKeyCredential:[r.hash]}:{ScriptCredential:[r.hash]}]}:null}}function ae(e,t){let r=(()=>"PublicKeyCredential"in e.paymentCredential?(0,i.keyHashToCredential)(e.paymentCredential.PublicKeyCredential[0]):(0,i.scriptHashToCredential)(e.paymentCredential.ScriptCredential[0]))(),o=(()=>{if(e.stakeCredential&&"Inline"in e.stakeCredential)return"PublicKeyCredential"in e.stakeCredential.Inline[0]?(0,i.keyHashToCredential)(e.stakeCredential.Inline[0].PublicKeyCredential[0]):(0,i.scriptHashToCredential)(e.stakeCredential.Inline[0].ScriptCredential[0])})();return(0,i.credentialToAddress)(t,r,o)}var ie=e=>{let t=(0,i.getAddressDetails)(e);if(!t.paymentCredential)return{type:"error",error:new Error("undefined paymentCredential")};let r=t.paymentCredential.type=="Key"?new i.Constr(0,[t.paymentCredential.hash]):new i.Constr(1,[t.paymentCredential.hash]);if(!t.stakeCredential)return{type:"ok",data:new i.Constr(0,[r,new i.Constr(1,[])])};let o=new i.Constr(0,[new i.Constr(0,[new i.Constr(0,[t.stakeCredential.hash])])]);return{type:"ok",data:new i.Constr(0,[r,o])}},ce=(e,t)=>{let r=Math.ceil(e.length/t);return[...Array(r)].map((o,n)=>e.slice(n*t,(n+1)*t))},le=(e,t)=>typeof t=="bigint"?t.toString():t,de=(e,t)=>1n+(e-1n)/t;function ue(e,t){let r=Object.entries(t),o={...e};return r.forEach(([n,s])=>{o[n]?o[n]+=s:o[n]=s}),o}function pe(e){let t=new Map;e.lovelace&&t.set("",new Map([["",e.lovelace]]));let r=Object.keys(e);return Array.from(new Set(r.filter(n=>n!=="lovelace").map(n=>n.slice(0,56)))).sort().forEach(n=>{let s=r.filter(l=>l.slice(0,56)===n),c=new Map;s.sort().forEach(l=>{c.set(l.slice(56),e[l])}),t.set(n,c)}),t}function me(e){let t={lovelace:e.get("")?.get("")||BigInt(0)};for(let[r,o]of e)if(r!=="")for(let[n,s]of o)t[r+n]=s;return t}function fe(e,t){let r=[],o=!1,n=new Map(Object.entries(t));for(let s of e)if(!s.scriptRef){o=!1;for(let[c,l]of n)if(Object.hasOwn(s.assets,c)){let u=s.assets[c];u>=l?n.delete(c):n.set(c,l-u),o=!0}if(o&&r.push(s),n.size==0)break}return n.size>0?{type:"error",error:new Error("Insufficient funds")}:{type:"ok",data:r}}function xe(e,t){let r=e.concat(t),o=q(r),n=new Map;return o.forEach((s,c)=>{n.set(s.txHash+s.outputIndex,BigInt(c))}),e.flatMap(s=>{let c=n.get(s.txHash+s.outputIndex);return c!==void 0?c:[]})}function q(e){return e.sort((t,r)=>t.txHash<r.txHash?-1:t.txHash>r.txHash?1:t.txHash==r.txHash?t.outputIndex<r.outputIndex?-1:1:0)}function ve(e){return e.map(t=>t.assets).reduce((t,r)=>(0,i.addAssets)(t,r),{})}function Se(e,t){for(let[r,o]of Object.entries(t))Object.hasOwn(e,r)&&(e[r]<o?delete e[r]:e[r]>o?e[r]-=o:delete e[r]);return e}var a=require("@lucid-evolution/lucid"),P=a.Data.Object({txHash:a.Data.Object({hash:a.Data.Bytes({minLength:32,maxLength:32})}),outputIndex:a.Data.Integer()}),ye=P,U=a.Data.Enum([a.Data.Object({PublicKeyCredential:a.Data.Tuple([a.Data.Bytes({minLength:28,maxLength:28})])}),a.Data.Object({ScriptCredential:a.Data.Tuple([a.Data.Bytes({minLength:28,maxLength:28})])})]),ge=U,$=a.Data.Object({paymentCredential:U,stakeCredential:a.Data.Nullable(a.Data.Enum([a.Data.Object({Inline:a.Data.Tuple([U])}),a.Data.Object({Pointer:a.Data.Tuple([a.Data.Object({slotNumber:a.Data.Integer(),transactionIndex:a.Data.Integer(),certificateIndex:a.Data.Integer()})])})]))}),Te=$,D=a.Data.Object({policyId:a.Data.Bytes(),assetName:a.Data.Bytes()},{hasConstr:!1}),_e=D,K=a.Data.Map(a.Data.Bytes(),a.Data.Map(a.Data.Bytes(),a.Data.Integer())),he=K,F=a.Data.Object({output_reference:P,input_index:a.Data.Integer()}),I=F,Y=a.Data.Enum([a.Data.Literal("UpdateService"),a.Data.Literal("RemoveService")]),B=Y,J=a.Data.Object({service_fee:D,service_fee_qty:a.Data.Integer(),penalty_fee:D,penalty_fee_qty:a.Data.Integer(),interval_length:a.Data.Integer(),num_intervals:a.Data.Integer(),minimum_ada:a.Data.Integer(),is_active:a.Data.Boolean()}),_=J,V={policyId:"",assetName:""};var T=require("@noble/hashes/utils"),W=require("@noble/hashes/sha3"),h={prefix100:"000643b0",prefix222:"000de140",prefix333:"0014df10",prefix444:"001bc280"},A=(e,t)=>{let r=(0,W.sha3_256)((0,T.hexToBytes)(e.txHash)),o=new Uint8Array([e.outputIndex]),n=(0,T.concatBytes)(r,o),s=(0,T.concatBytes)((0,T.hexToBytes)(t),n);return(0,T.bytesToHex)(s.slice(0,32))};var R=require("effect"),z=e=>{let t=A(e,h.prefix100),r=A(e,h.prefix222);return{refTokenName:t,userTokenName:r}},Ae=async(e,t)=>{let r=await e.wallet().address(),o=g(e,t.scripts),n=(0,m.mintingPolicyToId)(o.mintServiceValidator);console.log("servicePolicyId: ",n);let s=await e.utxosAt(r);(!s||!s.length)&&console.error("No UTxO found at user address: "+r);let{refTokenName:c,userTokenName:l}=z(s[0]);console.log("refTokenName: ",c),console.log("userTokenName: ",l);let u={kind:"selected",makeRedeemer:p=>{let E=s[0],L={output_reference:{txHash:{hash:E.txHash},outputIndex:BigInt(E.outputIndex)},input_index:p[0]};return console.log("createService :: ",m.Data.to(L,I)),m.Data.to(L,I)},inputs:s};console.log("REDEEMER :: ",u);let x={service_fee:V,service_fee_qty:10000000n,penalty_fee:V,penalty_fee_qty:1000000n,interval_length:1n,num_intervals:12n,minimum_ada:2000000n,is_active:!0},v=m.Data.to(x,_),S={txHash:{hash:s[0].txHash},outputIndex:BigInt(s[0].outputIndex)},f={output_reference:S,input_index:S.outputIndex};console.log("merchantUTxOs :: ",s);let b={[`${n}${c}`]:1n,[`${n}${l}`]:1n};try{let p=await e.newTx().collectFrom(s).mintAssets(b,u).validTo(Date.now()+9e5).attach.MintingPolicy(o.mintServiceValidator).complete();return console.log("data: ",p.toJSON()),{type:"ok",data:p}}catch(p){return console.log("ERROR: ",p),p instanceof Error?{type:"error",error:p}:{type:"error",error:new Error(`${JSON.stringify(p)}`)}}},Oe=async(e,t)=>R.Effect.gen(function*(){let r=yield*R.Effect.promise(()=>e.wallet().address()),o=g(e,t.scripts),n=(0,m.mintingPolicyToId)(o.mintServiceValidator);console.log("servicePolicyId: ",n);let s=yield*R.Effect.promise(()=>e.utxosAt(r));console.log("Merchant UTxO"),console.log(s),(!s||!s.length)&&console.error("No UTxO found at user address: "+r);let c=(0,m.selectUTxOs)(s,{lovelace:5000000n}),{refTokenName:l,userTokenName:u}=z(c[0]);console.log("refTokenName: ",l),console.log("userTokenName: ",u);let x={[`${n}${l}`]:1n,[`${n}${u}`]:1n},v={kind:"selected",makeRedeemer:p=>m.Data.to(new m.Constr(0,[p])),inputs:c},S=yield*R.Effect.promise(()=>e.wallet().getUtxos()),f=(0,m.selectUTxOs)(S,{lovelace:BigInt(2e6)});return yield*e.newTx().mintAssets(x,v).pay.ToAddress(o.mintServiceValAddress,{[`${n}${l}`]:1n}).validTo(Date.now()+9e5).attach.MintingPolicy(o.mintServiceValidator).completeProgram()});var d=require("@lucid-evolution/lucid");var Ce=async(e,t)=>{console.log("updateService..........: ");let r=await e.wallet().address(),o={type:"PlutusV2",script:t.scripts.spending},n=g(e,t.scripts),s=(0,d.mintingPolicyToId)(n.mintServiceValidator),c=(0,d.validatorToAddress)(e.config().network,o),l=await e.utxosAt(r);(!l||!l.length)&&console.error("No UTxO found at user address: "+r);let u=(0,d.toUnit)(s,"000643b09e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),x=(0,d.toUnit)(s,"000de1409e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),v=await e.utxosAtWithUnit(c,u),S=await e.utxosAtWithUnit(r,x);if(!v)throw new Error("Service NFT not found");console.log("serviceNFTUTxO: ",v);let f={service_fee:t.new_service_fee,service_fee_qty:t.new_service_fee_qty,penalty_fee:t.new_penalty_fee,penalty_fee_qty:t.new_penalty_fee_qty,interval_length:t.new_interval_length,num_intervals:t.new_num_intervals,minimum_ada:t.new_minimum_ada,is_active:t.is_active},b=d.Data.to(f,_),p=d.Data.to("UpdateService",B),E=()=>d.Data.to(new d.Constr(1,[new d.Constr(0,[])]));console.log("Redeemer updateService: ",p);try{let y=await e.newTx().collectFrom(S).collectFrom(v,E()).pay.ToAddress(r,{lovelace:3000000n,[x]:1n}).pay.ToContract(c,{kind:"inline",value:b},{lovelace:3000000n,[u]:1n}).attach.SpendingValidator(o).complete();return console.log("data: ",y.toJSON()),{type:"ok",data:y}}catch(y){return console.log("ERROR: ",y),y instanceof Error?{type:"error",error:y}:{type:"error",error:new Error(`${JSON.stringify(y)}`)}}};var O=require("@lucid-evolution/lucid");var we=36e5,Re=315576e5,be=631152e5,Ee=864e5,ke=.05,Ue=process.env.NODE_ENV=="emulator"?0:1e5,De="014e9d57e1623f7eeef5d0a8d4e6734a562ba32cf910244cd74e1680",Ie="5e8aa3f089868eaadf188426f49db6566624844b6c5d529b38f3b8a7";var Ve=e=>{let t=A(e,h.prefix100),r=A(e,h.prefix222);return{refTokenName:t,userTokenName:r}},Ne=async(e,t)=>{console.log("sendTokenToService...");let r=g(e,t.scripts),o=(0,O.mintingPolicyToId)(r.mintServiceValidator),n=await e.wallet().address(),s=await e.utxosAt(n),c=await e.utxosAt(r.spendServiceValAddress),{refTokenName:l,userTokenName:u}=Ve(s[0]);console.log("Service Validator Address: BEFORE>>>",r.spendServiceValAddress),console.log("Service Validator UTxO: BEFORE>>>",c);let x={service_fee:t.service_fee,service_fee_qty:t.service_fee_qty,penalty_fee:t.penalty_fee,penalty_fee_qty:t.penalty_fee_qty,interval_length:t.interval_length,num_intervals:t.num_intervals,minimum_ada:t.minimum_ada,is_active:t.is_active},v=O.Data.to(x,_),S=(0,O.toUnit)(o,l);console.log("PolicyId: ",o),console.log("refTokenName: ",l),console.log("userTokenName: ",u);try{let f=await e.newTx().pay.ToContract(r.spendServiceValAddress,{kind:"inline",value:v},{lovelace:5000000n,[S]:1n},r.spendServiceValidator).complete();return console.log("data: ",f.toJSON()),{type:"ok",data:f}}catch(f){return console.log("ERROR: ",f),f instanceof Error?{type:"error",error:f}:{type:"error",error:new Error(`${JSON.stringify(f)}`)}}};w(C,require("@lucid-evolution/lucid"),module.exports);0&&(module.exports={ADA,AddressD,AddressSchema,AssetClassD,AssetClassSchema,CreateServiceRedeemer,CreateServiceSchema,CredentialD,CredentialSchema,MintServiceRedeemer,MintServiceSchema,ONE_HOUR_MS,ONE_YEAR_MS,OutputReference,OutputReferenceSchema,PROTOCOL_FEE,PROTOCOL_PAYMENT_KEY,PROTOCOL_STAKE_KEY,ServiceDatum,ServiceDatumSchema,TIME_TOLERANCE_MS,TWENTY_FOUR_HOURS_MS,TWO_YEARS_MS,Value,ValueSchema,chunkArray,createService,createServiceEffect,divCeil,fromAddress,fromAddressToData,fromAssets,generateAccountSeedPhrase,getInputUtxoIndices,getServiceMultiValidator,ok,parseSafeDatum,parseUTxOsAtScript,remove,replacer,selectUtxos,sendTokenToService,sortByOutRefWithIndex,sumUtxoAssets,toAddress,toAssets,toCBORHex,union,updateService,utxosAtScript,...require("@lucid-evolution/lucid")});
