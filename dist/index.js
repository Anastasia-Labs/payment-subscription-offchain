import{Constr as le,Data as O,mintingPolicyToId as H,selectUTxOs as L}from"@lucid-evolution/lucid";import{validatorToAddress as K,validatorToRewardAddress as F}from"@lucid-evolution/lucid";var S=(e,t)=>{let r={type:"PlutusV2",script:t.minting},o=e.config().network,s=F(o,r),n={type:"PlutusV2",script:t.spending},i=K(o,n);return{spendServiceValidator:n,spendServiceValAddress:i,mintServiceValidator:r,mintServiceValAddress:s}};import{applyDoubleCborEncoding as Y,Constr as v,Data as J,generateSeedPhrase as W,getAddressDetails as V,Lucid as z,addAssets as G,Emulator as Q,validatorToAddress as D,keyHashToCredential as C,scriptHashToCredential as I,credentialToAddress as X}from"@lucid-evolution/lucid";function ke(e){return{type:"ok",data:e}}var Z=async(e,t,r)=>{let o=e.config().network,s={type:"PlutusV2",script:t},n=r?D(o,s,C(r)):D(o,s);return e.utxosAt(n)},ee=(e,t)=>{if(e)try{return{type:"right",value:J.from(e,t)}}catch(r){return{type:"left",value:`invalid datum : ${r}`}}else return{type:"left",value:"missing datum"}},Ue=async(e,t,r,o)=>{try{return(await Z(e,t,o)).flatMap(n=>{let i=ee(n.datum,r);return i.type=="right"?{outRef:{txHash:n.txHash,outputIndex:n.outputIndex},datum:i.value,assets:n.assets}:[]})}catch{return[]}},De=e=>Y(e),Ie=async e=>{let t=W(),r=await z(new Q([]),"Custom");r.selectWallet.fromSeed(t);let o=r.wallet().address;return{seedPhrase:t,address:o,assets:e}};function Ve(e){let{paymentCredential:t,stakeCredential:r}=V(e);if(!t)throw new Error("Not a valid payment address.");return{paymentCredential:t?.type==="Key"?{PublicKeyCredential:[t.hash]}:{ScriptCredential:[t.hash]},stakeCredential:r?{Inline:[r.type==="Key"?{PublicKeyCredential:[r.hash]}:{ScriptCredential:[r.hash]}]}:null}}function Ne(e,t){let r=(()=>"PublicKeyCredential"in e.paymentCredential?C(e.paymentCredential.PublicKeyCredential[0]):I(e.paymentCredential.ScriptCredential[0]))(),o=(()=>{if(e.stakeCredential&&"Inline"in e.stakeCredential)return"PublicKeyCredential"in e.stakeCredential.Inline[0]?C(e.stakeCredential.Inline[0].PublicKeyCredential[0]):I(e.stakeCredential.Inline[0].ScriptCredential[0])})();return X(t,r,o)}var Me=e=>{let t=V(e);if(!t.paymentCredential)return{type:"error",error:new Error("undefined paymentCredential")};let r=t.paymentCredential.type=="Key"?new v(0,[t.paymentCredential.hash]):new v(1,[t.paymentCredential.hash]);if(!t.stakeCredential)return{type:"ok",data:new v(0,[r,new v(1,[])])};let o=new v(0,[new v(0,[new v(0,[t.stakeCredential.hash])])]);return{type:"ok",data:new v(0,[r,o])}},Pe=(e,t)=>{let r=Math.ceil(e.length/t);return[...Array(r)].map((o,s)=>e.slice(s*t,(s+1)*t))},Be=(e,t)=>typeof t=="bigint"?t.toString():t,Le=(e,t)=>1n+(e-1n)/t;function He(e,t){let r=Object.entries(t),o={...e};return r.forEach(([s,n])=>{o[s]?o[s]+=n:o[s]=n}),o}function je(e){let t=new Map;e.lovelace&&t.set("",new Map([["",e.lovelace]]));let r=Object.keys(e);return Array.from(new Set(r.filter(s=>s!=="lovelace").map(s=>s.slice(0,56)))).sort().forEach(s=>{let n=r.filter(c=>c.slice(0,56)===s),i=new Map;n.sort().forEach(c=>{i.set(c.slice(56),e[c])}),t.set(s,i)}),t}function qe(e){let t={lovelace:e.get("")?.get("")||BigInt(0)};for(let[r,o]of e)if(r!=="")for(let[s,n]of o)t[r+s]=n;return t}function $e(e,t){let r=[],o=!1,s=new Map(Object.entries(t));for(let n of e)if(!n.scriptRef){o=!1;for(let[i,c]of s)if(Object.hasOwn(n.assets,i)){let l=n.assets[i];l>=c?s.delete(i):s.set(i,c-l),o=!0}if(o&&r.push(n),s.size==0)break}return s.size>0?{type:"error",error:new Error("Insufficient funds")}:{type:"ok",data:r}}function Ke(e,t){let r=e.concat(t),o=te(r),s=new Map;return o.forEach((n,i)=>{s.set(n.txHash+n.outputIndex,BigInt(i))}),e.flatMap(n=>{let i=s.get(n.txHash+n.outputIndex);return i!==void 0?i:[]})}function te(e){return e.sort((t,r)=>t.txHash<r.txHash?-1:t.txHash>r.txHash?1:t.txHash==r.txHash?t.outputIndex<r.outputIndex?-1:1:0)}function Fe(e){return e.map(t=>t.assets).reduce((t,r)=>G(t,r),{})}function Ye(e,t){for(let[r,o]of Object.entries(t))Object.hasOwn(e,r)&&(e[r]<o?delete e[r]:e[r]>o?e[r]-=o:delete e[r]);return e}import{Data as a}from"@lucid-evolution/lucid";var N=a.Object({txHash:a.Object({hash:a.Bytes({minLength:32,maxLength:32})}),outputIndex:a.Integer()}),et=N,w=a.Enum([a.Object({PublicKeyCredential:a.Tuple([a.Bytes({minLength:28,maxLength:28})])}),a.Object({ScriptCredential:a.Tuple([a.Bytes({minLength:28,maxLength:28})])})]),tt=w,re=a.Object({paymentCredential:w,stakeCredential:a.Nullable(a.Enum([a.Object({Inline:a.Tuple([w])}),a.Object({Pointer:a.Tuple([a.Object({slotNumber:a.Integer(),transactionIndex:a.Integer(),certificateIndex:a.Integer()})])})]))}),rt=re,R=a.Object({policyId:a.Bytes(),assetName:a.Bytes()},{hasConstr:!1}),nt=R,ne=a.Map(a.Bytes(),a.Map(a.Bytes(),a.Integer())),ot=ne,oe=a.Object({output_reference:N,input_index:a.Integer()}),b=oe,se=a.Enum([a.Literal("UpdateService"),a.Literal("RemoveService")]),M=se,ae=a.Object({service_fee:R,service_fee_qty:a.Integer(),penalty_fee:R,penalty_fee_qty:a.Integer(),interval_length:a.Integer(),num_intervals:a.Integer(),minimum_ada:a.Integer(),is_active:a.Boolean()}),y=ae,E={policyId:"",assetName:""};import{bytesToHex as ie,concatBytes as P,hexToBytes as B}from"@noble/hashes/utils";import{sha3_256 as ce}from"@noble/hashes/sha3";var g={prefix100:"000643b0",prefix222:"000de140",prefix333:"0014df10",prefix444:"001bc280"},T=(e,t)=>{let r=ce(B(e.txHash)),o=new Uint8Array([e.outputIndex]),s=P(r,o),n=P(B(t),s);return ie(n.slice(0,32))};import{Effect as A}from"effect";var j=e=>{let t=T(e,g.prefix100),r=T(e,g.prefix222);return{refTokenName:t,userTokenName:r}},Et=async(e,t)=>{let r=await e.wallet().address(),o=S(e,t.scripts),s=H(o.mintServiceValidator);console.log("servicePolicyId: ",s);let n=await e.utxosAt(r);(!n||!n.length)&&console.error("No UTxO found at user address: "+r);let{refTokenName:i,userTokenName:c}=j(n[0]);console.log("refTokenName: ",i),console.log("userTokenName: ",c);let l={kind:"selected",makeRedeemer:d=>{let h=n[0],U={output_reference:{txHash:{hash:h.txHash},outputIndex:BigInt(h.outputIndex)},input_index:d[0]};return console.log("createService :: ",O.to(U,b)),O.to(U,b)},inputs:n};console.log("REDEEMER :: ",l);let p={service_fee:E,service_fee_qty:10000000n,penalty_fee:E,penalty_fee_qty:1000000n,interval_length:1n,num_intervals:12n,minimum_ada:2000000n,is_active:!0},m=O.to(p,y),f={txHash:{hash:n[0].txHash},outputIndex:BigInt(n[0].outputIndex)},u={output_reference:f,input_index:f.outputIndex};console.log("merchantUTxOs :: ",n);let _={[`${s}${i}`]:1n,[`${s}${c}`]:1n};try{let d=await e.newTx().collectFrom(n).mintAssets(_,l).validTo(Date.now()+9e5).attach.MintingPolicy(o.mintServiceValidator).complete();return console.log("data: ",d.toJSON()),{type:"ok",data:d}}catch(d){return console.log("ERROR: ",d),d instanceof Error?{type:"error",error:d}:{type:"error",error:new Error(`${JSON.stringify(d)}`)}}},kt=async(e,t)=>A.gen(function*(){let r=yield*A.promise(()=>e.wallet().address()),o=S(e,t.scripts),s=H(o.mintServiceValidator);console.log("servicePolicyId: ",s);let n=yield*A.promise(()=>e.utxosAt(r));console.log("Merchant UTxO"),console.log(n),(!n||!n.length)&&console.error("No UTxO found at user address: "+r);let i=L(n,{lovelace:5000000n}),{refTokenName:c,userTokenName:l}=j(i[0]);console.log("refTokenName: ",c),console.log("userTokenName: ",l);let p={[`${s}${c}`]:1n,[`${s}${l}`]:1n},m={kind:"selected",makeRedeemer:d=>O.to(new le(0,[d])),inputs:i},f=yield*A.promise(()=>e.wallet().getUtxos()),u=L(f,{lovelace:BigInt(2e6)});return yield*e.newTx().mintAssets(p,m).pay.ToAddress(o.mintServiceValAddress,{[`${s}${c}`]:1n}).validTo(Date.now()+9e5).attach.MintingPolicy(o.mintServiceValidator).completeProgram()});import{Constr as q,Data as k,mintingPolicyToId as de,toUnit as $,validatorToAddress as ue}from"@lucid-evolution/lucid";var qt=async(e,t)=>{console.log("updateService..........: ");let r=await e.wallet().address(),o={type:"PlutusV2",script:t.scripts.spending},s=S(e,t.scripts),n=de(s.mintServiceValidator),i=ue(e.config().network,o),c=await e.utxosAt(r);(!c||!c.length)&&console.error("No UTxO found at user address: "+r);let l=$(n,"000643b09e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),p=$(n,"000de1409e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),m=await e.utxosAtWithUnit(i,l),f=await e.utxosAtWithUnit(r,p);if(!m)throw new Error("Service NFT not found");console.log("serviceNFTUTxO: ",m);let u={service_fee:t.new_service_fee,service_fee_qty:t.new_service_fee_qty,penalty_fee:t.new_penalty_fee,penalty_fee_qty:t.new_penalty_fee_qty,interval_length:t.new_interval_length,num_intervals:t.new_num_intervals,minimum_ada:t.new_minimum_ada,is_active:t.is_active},_=k.to(u,y),d=k.to("UpdateService",M),h=()=>k.to(new q(1,[new q(0,[])]));console.log("Redeemer updateService: ",d);try{let x=await e.newTx().collectFrom(f).collectFrom(m,h()).pay.ToAddress(r,{lovelace:3000000n,[p]:1n}).pay.ToContract(i,{kind:"inline",value:_},{lovelace:3000000n,[l]:1n}).attach.SpendingValidator(o).complete();return console.log("data: ",x.toJSON()),{type:"ok",data:x}}catch(x){return console.log("ERROR: ",x),x instanceof Error?{type:"error",error:x}:{type:"error",error:new Error(`${JSON.stringify(x)}`)}}};import{Data as pe,mintingPolicyToId as me,toUnit as fe}from"@lucid-evolution/lucid";var Kt=36e5,Ft=315576e5,Yt=631152e5,Jt=864e5,Wt=.05,zt=process.env.NODE_ENV=="emulator"?0:1e5,Gt="014e9d57e1623f7eeef5d0a8d4e6734a562ba32cf910244cd74e1680",Qt="5e8aa3f089868eaadf188426f49db6566624844b6c5d529b38f3b8a7";var xe=e=>{let t=T(e,g.prefix100),r=T(e,g.prefix222);return{refTokenName:t,userTokenName:r}},xr=async(e,t)=>{console.log("sendTokenToService...");let r=S(e,t.scripts),o=me(r.mintServiceValidator),s=await e.wallet().address(),n=await e.utxosAt(s),i=await e.utxosAt(r.spendServiceValAddress),{refTokenName:c,userTokenName:l}=xe(n[0]);console.log("Service Validator Address: BEFORE>>>",r.spendServiceValAddress),console.log("Service Validator UTxO: BEFORE>>>",i);let p={service_fee:t.service_fee,service_fee_qty:t.service_fee_qty,penalty_fee:t.penalty_fee,penalty_fee_qty:t.penalty_fee_qty,interval_length:t.interval_length,num_intervals:t.num_intervals,minimum_ada:t.minimum_ada,is_active:t.is_active},m=pe.to(p,y),f=fe(o,c);console.log("PolicyId: ",o),console.log("refTokenName: ",c),console.log("userTokenName: ",l);try{let u=await e.newTx().pay.ToContract(r.spendServiceValAddress,{kind:"inline",value:m},{lovelace:5000000n,[f]:1n},r.spendServiceValidator).complete();return console.log("data: ",u.toJSON()),{type:"ok",data:u}}catch(u){return console.log("ERROR: ",u),u instanceof Error?{type:"error",error:u}:{type:"error",error:new Error(`${JSON.stringify(u)}`)}}};export*from"@lucid-evolution/lucid";export{E as ADA,rt as AddressD,re as AddressSchema,nt as AssetClassD,R as AssetClassSchema,b as CreateServiceRedeemer,oe as CreateServiceSchema,tt as CredentialD,w as CredentialSchema,M as MintServiceRedeemer,se as MintServiceSchema,Kt as ONE_HOUR_MS,Ft as ONE_YEAR_MS,et as OutputReference,N as OutputReferenceSchema,Wt as PROTOCOL_FEE,Gt as PROTOCOL_PAYMENT_KEY,Qt as PROTOCOL_STAKE_KEY,y as ServiceDatum,ae as ServiceDatumSchema,zt as TIME_TOLERANCE_MS,Jt as TWENTY_FOUR_HOURS_MS,Yt as TWO_YEARS_MS,ot as Value,ne as ValueSchema,Pe as chunkArray,Et as createService,kt as createServiceEffect,Le as divCeil,Ve as fromAddress,Me as fromAddressToData,je as fromAssets,Ie as generateAccountSeedPhrase,Ke as getInputUtxoIndices,S as getServiceMultiValidator,ke as ok,ee as parseSafeDatum,Ue as parseUTxOsAtScript,Ye as remove,Be as replacer,$e as selectUtxos,xr as sendTokenToService,te as sortByOutRefWithIndex,Fe as sumUtxoAssets,Ne as toAddress,qe as toAssets,De as toCBORHex,He as union,qt as updateService,Z as utxosAtScript};
