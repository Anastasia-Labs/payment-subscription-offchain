import{Constr as Ge,Data as B,mintingPolicyToId as ge,selectUTxOs as ye}from"@lucid-evolution/lucid";import{validatorToAddress as _e,validatorToRewardAddress as Ae}from"@lucid-evolution/lucid";var v=(e,t)=>{let r={type:"PlutusV2",script:t.minting},n=e.config().network,o=Ae(n,r),s={type:"PlutusV2",script:t.spending},i=_e(n,s);return{spendServiceValidator:s,spendServiceValAddress:i,mintServiceValidator:r,mintServiceValAddress:o}};import{applyDoubleCborEncoding as we,Constr as g,Data as Te,generateSeedPhrase as Oe,getAddressDetails as z,Lucid as be,addAssets as ke,Emulator as Ce,validatorToAddress as Y,keyHashToCredential as N,scriptHashToCredential as J,credentialToAddress as Ee}from"@lucid-evolution/lucid";function gt(e){return{type:"ok",data:e}}var Ie=async(e,t,r)=>{let n=e.config().network,o={type:"PlutusV2",script:t},s=r?Y(n,o,N(r)):Y(n,o);return e.utxosAt(s)},Re=(e,t)=>{if(e)try{return{type:"right",value:Te.from(e,t)}}catch(r){return{type:"left",value:`invalid datum : ${r}`}}else return{type:"left",value:"missing datum"}},St=async(e,t,r,n)=>{try{return(await Ie(e,t,n)).flatMap(s=>{let i=Re(s.datum,r);return i.type=="right"?{outRef:{txHash:s.txHash,outputIndex:s.outputIndex},datum:i.value,assets:s.assets}:[]})}catch{return[]}},vt=e=>we(e),_t=async e=>{let t=Oe(),r=await be(new Ce([]),"Custom");r.selectWallet.fromSeed(t);let n=r.wallet().address;return{seedPhrase:t,address:n,assets:e}};function At(e){let{paymentCredential:t,stakeCredential:r}=z(e);if(!t)throw new Error("Not a valid payment address.");return{paymentCredential:t?.type==="Key"?{PublicKeyCredential:[t.hash]}:{ScriptCredential:[t.hash]},stakeCredential:r?{Inline:[r.type==="Key"?{PublicKeyCredential:[r.hash]}:{ScriptCredential:[r.hash]}]}:null}}function wt(e,t){let r=(()=>"PublicKeyCredential"in e.paymentCredential?N(e.paymentCredential.PublicKeyCredential[0]):J(e.paymentCredential.ScriptCredential[0]))(),n=(()=>{if(e.stakeCredential&&"Inline"in e.stakeCredential)return"PublicKeyCredential"in e.stakeCredential.Inline[0]?N(e.stakeCredential.Inline[0].PublicKeyCredential[0]):J(e.stakeCredential.Inline[0].ScriptCredential[0])})();return Ee(t,r,n)}var Tt=e=>{let t=z(e);if(!t.paymentCredential)return{type:"error",error:new Error("undefined paymentCredential")};let r=t.paymentCredential.type=="Key"?new g(0,[t.paymentCredential.hash]):new g(1,[t.paymentCredential.hash]);if(!t.stakeCredential)return{type:"ok",data:new g(0,[r,new g(1,[])])};let n=new g(0,[new g(0,[new g(0,[t.stakeCredential.hash])])]);return{type:"ok",data:new g(0,[r,n])}},Ot=(e,t)=>{let r=Math.ceil(e.length/t);return[...Array(r)].map((n,o)=>e.slice(o*t,(o+1)*t))},bt=(e,t)=>typeof t=="bigint"?t.toString():t,kt=(e,t)=>1n+(e-1n)/t;function Ct(e,t){let r=Object.entries(t),n={...e};return r.forEach(([o,s])=>{n[o]?n[o]+=s:n[o]=s}),n}function Et(e){let t=new Map;e.lovelace&&t.set("",new Map([["",e.lovelace]]));let r=Object.keys(e);return Array.from(new Set(r.filter(o=>o!=="lovelace").map(o=>o.slice(0,56)))).sort().forEach(o=>{let s=r.filter(a=>a.slice(0,56)===o),i=new Map;s.sort().forEach(a=>{i.set(a.slice(56),e[a])}),t.set(o,i)}),t}function It(e){let t={lovelace:e.get("")?.get("")||BigInt(0)};for(let[r,n]of e)if(r!=="")for(let[o,s]of n)t[r+o]=s;return t}function Rt(e,t){let r=[],n=!1,o=new Map(Object.entries(t));for(let s of e)if(!s.scriptRef){n=!1;for(let[i,a]of o)if(Object.hasOwn(s.assets,i)){let l=s.assets[i];l>=a?o.delete(i):o.set(i,a-l),n=!0}if(n&&r.push(s),o.size==0)break}return o.size>0?{type:"error",error:new Error("Insufficient funds")}:{type:"ok",data:r}}function Ut(e,t){let r=e.concat(t),n=Ue(r),o=new Map;return n.forEach((s,i)=>{o.set(s.txHash+s.outputIndex,BigInt(i))}),e.flatMap(s=>{let i=o.get(s.txHash+s.outputIndex);return i!==void 0?i:[]})}function Ue(e){return e.sort((t,r)=>t.txHash<r.txHash?-1:t.txHash>r.txHash?1:t.txHash==r.txHash?t.outputIndex<r.outputIndex?-1:1:0)}function Lt(e){return e.map(t=>t.assets).reduce((t,r)=>ke(t,r),{})}function Bt(e,t){for(let[r,n]of Object.entries(t))Object.hasOwn(e,r)&&(e[r]<n?delete e[r]:e[r]>n?e[r]-=n:delete e[r]);return e}import{Data as c}from"@lucid-evolution/lucid";var G=c.Object({txHash:c.Object({hash:c.Bytes({minLength:32,maxLength:32})}),outputIndex:c.Integer()}),$t=G,V=c.Enum([c.Object({PublicKeyCredential:c.Tuple([c.Bytes({minLength:28,maxLength:28})])}),c.Object({ScriptCredential:c.Tuple([c.Bytes({minLength:28,maxLength:28})])})]),Ft=V,Le=c.Object({paymentCredential:V,stakeCredential:c.Nullable(c.Enum([c.Object({Inline:c.Tuple([V])}),c.Object({Pointer:c.Tuple([c.Object({slotNumber:c.Integer(),transactionIndex:c.Integer(),certificateIndex:c.Integer()})])})]))}),qt=Le,H=c.Object({symbol:c.Bytes(),name:c.Bytes()},{hasConstr:!1}),Kt=H,Be=c.Map(c.Bytes(),c.Map(c.Bytes(),c.Integer())),Wt=Be,De=c.Object({output_reference:G,input_index:c.Integer()}),T=De,Ne=c.Enum([c.Literal("UpdateService"),c.Literal("RemoveService")]),M=Ne,Ve=c.Object({service_fee:H,service_fee_qty:c.Integer(),penalty_fee:H,penalty_fee_qty:c.Integer(),interval_length:c.Integer(),num_intervals:c.Integer(),minimum_ada:c.Integer()}),O=Ve,P={symbol:"",name:""};function j(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function He(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function _(e,...t){if(!He(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function $(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Q(e,t){_(e);let r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}var ee=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));var F=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68,Me=e=>e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255;function q(e){for(let t=0;t<e.length;t++)e[t]=Me(e[t])}var Pe=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function te(e){_(e);let t="";for(let r=0;r<e.length;r++)t+=Pe[e[r]];return t}var h={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Z(e){if(e>=h._0&&e<=h._9)return e-h._0;if(e>=h._A&&e<=h._F)return e-(h._A-10);if(e>=h._a&&e<=h._f)return e-(h._a-10)}function K(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);let t=e.length,r=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);let n=new Uint8Array(r);for(let o=0,s=0;o<r;o++,s+=2){let i=Z(e.charCodeAt(s)),a=Z(e.charCodeAt(s+1));if(i===void 0||a===void 0){let l=e[s]+e[s+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+s)}n[o]=i*16+a}return n}function je(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function R(e){return typeof e=="string"&&(e=je(e)),_(e),e}function W(...e){let t=0;for(let n=0;n<e.length;n++){let o=e[n];_(o),t+=o.length}let r=new Uint8Array(t);for(let n=0,o=0;n<e.length;n++){let s=e[n];r.set(s,o),o+=s.length}return r}var I=class{clone(){return this._cloneInto()}},zt={}.toString;function re(e){let t=n=>e().update(R(n)).digest(),r=e();return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=()=>e(),t}function ne(e){let t=(n,o)=>e(o).update(R(n)).digest(),r=e({});return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=n=>e(n),t}var U=BigInt(4294967295),oe=BigInt(32);function $e(e,t=!1){return t?{h:Number(e&U),l:Number(e>>oe&U)}:{h:Number(e>>oe&U)|0,l:Number(e&U)|0}}function se(e,t=!1){let r=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let o=0;o<e.length;o++){let{h:s,l:i}=$e(e[o],t);[r[o],n[o]]=[s,i]}return[r,n]}var ie=(e,t,r)=>e<<r|t>>>32-r,ae=(e,t,r)=>t<<r|e>>>32-r,ce=(e,t,r)=>t<<r-32|e>>>64-r,le=(e,t,r)=>e<<r-32|t>>>64-r;var pe=[],fe=[],me=[],Fe=BigInt(0),C=BigInt(1),qe=BigInt(2),Ke=BigInt(7),We=BigInt(256),Xe=BigInt(113);for(let e=0,t=C,r=1,n=0;e<24;e++){[r,n]=[n,(2*r+3*n)%5],pe.push(2*(5*n+r)),fe.push((e+1)*(e+2)/2%64);let o=Fe;for(let s=0;s<7;s++)t=(t<<C^(t>>Ke)*Xe)%We,t&qe&&(o^=C<<(C<<BigInt(s))-C);me.push(o)}var[Ye,Je]=se(me,!0),ue=(e,t,r)=>r>32?ce(e,t,r):ie(e,t,r),de=(e,t,r)=>r>32?le(e,t,r):ae(e,t,r);function ze(e,t=24){let r=new Uint32Array(10);for(let n=24-t;n<24;n++){for(let i=0;i<10;i++)r[i]=e[i]^e[i+10]^e[i+20]^e[i+30]^e[i+40];for(let i=0;i<10;i+=2){let a=(i+8)%10,l=(i+2)%10,f=r[l],u=r[l+1],x=ue(f,u,1)^r[a],d=de(f,u,1)^r[a+1];for(let y=0;y<50;y+=10)e[i+y]^=x,e[i+y+1]^=d}let o=e[2],s=e[3];for(let i=0;i<24;i++){let a=fe[i],l=ue(o,s,a),f=de(o,s,a),u=pe[i];o=e[u],s=e[u+1],e[u]=l,e[u+1]=f}for(let i=0;i<50;i+=10){for(let a=0;a<10;a++)r[a]=e[i+a];for(let a=0;a<10;a++)e[i+a]^=~r[(a+2)%10]&r[(a+4)%10]}e[0]^=Ye[n],e[1]^=Je[n]}r.fill(0)}var b=class extends I{constructor(t,r,n,o=!1,s=24){if(super(),this.blockLen=t,this.suffix=r,this.outputLen=n,this.enableXOF=o,this.rounds=s,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,j(n),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=ee(this.state)}keccak(){F||q(this.state32),ze(this.state32,this.rounds),F||q(this.state32),this.posOut=0,this.pos=0}update(t){$(this);let{blockLen:r,state:n}=this;t=R(t);let o=t.length;for(let s=0;s<o;){let i=Math.min(r-this.pos,o-s);for(let a=0;a<i;a++)n[this.pos++]^=t[s++];this.pos===r&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:t,suffix:r,pos:n,blockLen:o}=this;t[n]^=r,r&128&&n===o-1&&this.keccak(),t[o-1]^=128,this.keccak()}writeInto(t){$(this,!1),_(t),this.finish();let r=this.state,{blockLen:n}=this;for(let o=0,s=t.length;o<s;){this.posOut>=n&&this.keccak();let i=Math.min(n-this.posOut,s-o);t.set(r.subarray(this.posOut,this.posOut+i),o),this.posOut+=i,o+=i}return t}xofInto(t){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(t)}xof(t){return j(t),this.xofInto(new Uint8Array(t))}digestInto(t){if(Q(t,this),this.finished)throw new Error("digest() was already called");return this.writeInto(t),this.destroy(),t}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){let{blockLen:r,suffix:n,outputLen:o,rounds:s,enableXOF:i}=this;return t||(t=new b(r,n,o,i,s)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=s,t.suffix=n,t.outputLen=o,t.enableXOF=i,t.destroyed=this.destroyed,t}},S=(e,t,r)=>re(()=>new b(t,e,r)),rr=S(6,144,224/8),xe=S(6,136,256/8),nr=S(6,104,384/8),or=S(6,72,512/8),sr=S(1,144,224/8),ir=S(1,136,256/8),ar=S(1,104,384/8),cr=S(1,72,512/8),he=(e,t,r)=>ne((n={})=>new b(t,e,n.dkLen===void 0?r:n.dkLen,!0)),lr=he(31,168,128/8),ur=he(31,136,256/8);var A={prefix100:"000643b0",prefix222:"000de140",prefix333:"0014df10",prefix444:"001bc280"},w=(e,t)=>{let r=xe(K(e.txHash)),n=new Uint8Array([e.outputIndex]),o=W(r,n),s=W(K(t),o);return te(s.slice(0,32))};import{Effect as L}from"effect";var Se=e=>{let t=w(e,A.prefix100),r=w(e,A.prefix222);return{refTokenName:t,userTokenName:r}},Dr=async(e,t)=>{let r=await e.wallet().address(),n=v(e,t.scripts),o=ge(n.mintServiceValidator);console.log("servicePolicyId: ",o);let s=await e.utxosAt(r);(!s||!s.length)&&console.error("No UTxO found at user address: "+r);let{refTokenName:i,userTokenName:a}=Se(s[0]);console.log("refTokenName: ",i),console.log("userTokenName: ",a);let l={kind:"selected",makeRedeemer:p=>{let D=s[0],k={output_reference:{txHash:{hash:D.txHash},outputIndex:BigInt(D.outputIndex)},input_index:p[0]};return console.log("createService :: ",B.to(k,T)),B.to(k,T)},inputs:s};console.log("REDEEMER :: ",l);let f={service_fee:P,service_fee_qty:10000000n,penalty_fee:P,penalty_fee_qty:1000000n,interval_length:1n,num_intervals:12n,minimum_ada:2000000n},u=B.to(f,O),x={txHash:{hash:s[0].txHash},outputIndex:BigInt(s[0].outputIndex)},d={output_reference:x,input_index:x.outputIndex};console.log("merchantUTxOs :: ",s);let y={[`${o}${i}`]:1n,[`${o}${a}`]:1n};try{let p=await e.newTx().collectFrom(s).mintAssets(y,l).validTo(Date.now()+9e5).attach.MintingPolicy(n.mintServiceValidator).complete();return console.log("data: ",p.toJSON()),{type:"ok",data:p}}catch(p){return console.log("ERROR: ",p),p instanceof Error?{type:"error",error:p}:{type:"error",error:new Error(`${JSON.stringify(p)}`)}}},Nr=async(e,t)=>L.gen(function*(){let r=yield*L.promise(()=>e.wallet().address()),n=v(e,t.scripts),o=ge(n.mintServiceValidator);console.log("servicePolicyId: ",o);let s=yield*L.promise(()=>e.utxosAt(r));console.log("Merchant UTxO"),console.log(s),(!s||!s.length)&&console.error("No UTxO found at user address: "+r);let i=ye(s,{lovelace:5000000n}),{refTokenName:a,userTokenName:l}=Se(i[0]);console.log("refTokenName: ",a),console.log("userTokenName: ",l);let f={[`${o}${a}`]:1n,[`${o}${l}`]:1n},u={kind:"selected",makeRedeemer:p=>B.to(new Ge(0,[p])),inputs:i},x=yield*L.promise(()=>e.wallet().getUtxos()),d=ye(x,{lovelace:BigInt(2e6)});return yield*e.newTx().mintAssets(f,u).pay.ToAddress(n.mintServiceValAddress,{[`${o}${a}`]:1n}).validTo(Date.now()+9e5).attach.MintingPolicy(n.mintServiceValidator).completeProgram()});import{Data as E,mintingPolicyToId as Qe,toUnit as ve}from"@lucid-evolution/lucid";var cn=async(e,t)=>{console.log("updateService..........: ");let r=await e.wallet().address(),n=v(e,t.scripts),o=Qe(n.mintServiceValidator);console.log("servicePolicyId: ",o);let s=await e.utxosAt(r);(!s||!s.length)&&console.error("No UTxO found at user address: "+r);let i=ve("0d7895b6e27a70a4175c822a1e792a2fdc59817f7f7773079044812f","000643b09e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),a=ve("0d7895b6e27a70a4175c822a1e792a2fdc59817f7f7773079044812f","000de1409e6291970cb44dd94008c79bcaf9d86f18b4b49ba5b2a04781db7199"),l=await e.utxosAtWithUnit(n.spendServiceValAddress,i);if(!l)throw new Error("Service NFT not found");console.log("serviceNFTUTxO: ",l);let f={kind:"selected",makeRedeemer:m=>{let k=s[0],X={output_reference:{txHash:{hash:k.txHash},outputIndex:BigInt(k.outputIndex)},input_index:m[0]};return console.log("createService :: ",E.to(X,T)),E.to(X,T)},inputs:s},u={service_fee:t.new_service_fee,service_fee_qty:t.new_service_fee_qty,penalty_fee:t.new_penalty_fee,penalty_fee_qty:t.new_penalty_fee_qty,interval_length:t.new_interval_length,num_intervals:t.new_num_intervals,minimum_ada:t.new_minimum_ada},x=E.to(u,O),d={txHash:{hash:s[0].txHash},outputIndex:BigInt(s[0].outputIndex)},y={output_reference:d,input_index:d.outputIndex},p=E.to("UpdateService",M),D=E.to("RemoveService",M);console.log("Redeemer updateService: ",p);try{let m=await e.newTx().collectFrom(s).collectFrom(l,p).pay.ToAddress(r,{[a]:1n}).attach.SpendingValidator(n.spendServiceValidator).complete();return console.log("data: ",m.toJSON()),{type:"ok",data:m}}catch(m){return console.log("ERROR: ",m),m instanceof Error?{type:"error",error:m}:{type:"error",error:new Error(`${JSON.stringify(m)}`)}}};import{Data as Ze,mintingPolicyToId as et,toUnit as tt}from"@lucid-evolution/lucid";var un=36e5,dn=315576e5,pn=631152e5,fn=864e5,mn=.05,xn=process.env.NODE_ENV=="emulator"?0:1e5,hn="014e9d57e1623f7eeef5d0a8d4e6734a562ba32cf910244cd74e1680",yn="5e8aa3f089868eaadf188426f49db6566624844b6c5d529b38f3b8a7";var rt=e=>{let t=w(e,A.prefix100),r=w(e,A.prefix222);return{refTokenName:t,userTokenName:r}},Dn=async(e,t)=>{console.log("sendTokenToService...");let r=v(e,t.scripts),n=et(r.mintServiceValidator),o=await e.wallet().address(),s=await e.utxosAt(o),i=await e.utxosAt(r.spendServiceValAddress),{refTokenName:a,userTokenName:l}=rt(s[0]);console.log("Service Validator Address: BEFORE>>>",r.spendServiceValAddress),console.log("Service Validator UTxO: BEFORE>>>",i);let f={service_fee:t.service_fee,service_fee_qty:t.service_fee_qty,penalty_fee:t.penalty_fee,penalty_fee_qty:t.penalty_fee_qty,interval_length:t.interval_length,num_intervals:t.num_intervals,minimum_ada:t.minimum_ada},u=Ze.to(f,O),x=tt(n,a);console.log("PolicyId: ",n),console.log("refTokenName: ",a),console.log("userTokenName: ",l);try{let d=await e.newTx().pay.ToContract(r.spendServiceValAddress,{kind:"inline",value:u},{lovelace:5000000n,[x]:1n}).complete();return console.log("data: ",d.toJSON()),{type:"ok",data:d}}catch(d){return console.log("ERROR: ",d),d instanceof Error?{type:"error",error:d}:{type:"error",error:new Error(`${JSON.stringify(d)}`)}}};export*from"@lucid-evolution/lucid";export{P as ADA,qt as AddressD,Le as AddressSchema,Kt as AssetClassD,H as AssetClassSchema,T as CreateServiceRedeemer,De as CreateServiceSchema,Ft as CredentialD,V as CredentialSchema,Ne as MintAccountSchema,M as MintServiceRedeemer,un as ONE_HOUR_MS,dn as ONE_YEAR_MS,$t as OutputReference,G as OutputReferenceSchema,mn as PROTOCOL_FEE,hn as PROTOCOL_PAYMENT_KEY,yn as PROTOCOL_STAKE_KEY,O as ServiceDatum,Ve as ServiceDatumSchema,xn as TIME_TOLERANCE_MS,fn as TWENTY_FOUR_HOURS_MS,pn as TWO_YEARS_MS,Wt as Value,Be as ValueSchema,Ot as chunkArray,Dr as createService,Nr as createServiceEffect,kt as divCeil,At as fromAddress,Tt as fromAddressToData,Et as fromAssets,_t as generateAccountSeedPhrase,Ut as getInputUtxoIndices,v as getServiceMultiValidator,gt as ok,Re as parseSafeDatum,St as parseUTxOsAtScript,Bt as remove,bt as replacer,Rt as selectUtxos,Dn as sendTokenToService,Ue as sortByOutRefWithIndex,Lt as sumUtxoAssets,wt as toAddress,It as toAssets,vt as toCBORHex,Ct as union,cn as updateService,Ie as utxosAtScript};
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
